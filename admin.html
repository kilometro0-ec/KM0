<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Panel de Control KM0 - Ing. Darwin Mu√±oz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#ec1313", "card": "#111", "border": "#222" }
                }
            }
        }
    </script>
    <style>
        body { background: #000; color: white; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .ios-blur { backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
        .tab-active { color: #ec1313; border-bottom: 2px solid #ec1313; }
        .btn-doc { background: #0a0a0a; border: 1px solid #222; padding: 14px; border-radius: 16px; font-size: 10px; font-weight: 900; display: flex; align-items: center; gap: 12px; transition: 0.3s; width: 100%; text-align: left; }
        .btn-doc:active { background: #1a0505; border-color: #ec1313; transform: scale(0.98); }
        .badge-count { background: #ec1313; color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; vertical-align: middle; }
    </style>
</head>
<body class="pb-64">

    <header class="sticky top-0 z-50 bg-black/80 ios-blur border-b border-border px-6 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="h-10 w-10 bg-primary rounded-full flex items-center justify-center font-black text-white italic">D</div>
            <div>
                <h1 class="text-[10px] font-black text-primary uppercase tracking-[0.2em]">Administrador</h1>
                <p class="text-sm font-bold italic">Ing. Darwin Mu√±oz</p>
            </div>
        </div>
        <button onclick="location.reload()" class="material-symbols-outlined text-zinc-500 hover:text-white transition-colors">sync</button>
    </header>

    <nav class="flex border-b border-border bg-zinc-900/10 sticky top-[73px] z-40 ios-blur">
        <button onclick="cambiarTab('motorizados')" id="tM" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest tab-active">
            Motorizados <span id="countM" class="badge-count">0</span>
        </button>
        <button onclick="cambiarTab('tiendas')" id="tT" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-zinc-500">
            Tiendas <span id="countT" class="badge-count">0</span>
        </button>
    </nav>

    <main id="main" class="p-6 max-w-xl mx-auto">
        <div id="loading" class="flex flex-col items-center py-32 space-y-4">
            <div class="animate-spin h-6 w-6 border-2 border-primary border-t-transparent rounded-full"></div>
            <p class="text-[10px] font-black uppercase tracking-widest text-zinc-600">Sincronizando con Excel...</p>
        </div>
        <div id="content" class="hidden"></div>
    </main>

    <footer id="footer" class="fixed bottom-0 inset-x-0 p-6 bg-black/95 border-t border-border ios-blur z-50 hidden">
        <div class="max-w-md mx-auto">
            <label class="text-[9px] font-black uppercase text-zinc-500 mb-2 block tracking-widest">Observaciones de Revisi√≥n</label>
            <textarea id="notas" class="w-full bg-zinc-900 border border-border rounded-2xl p-4 text-xs mb-4 outline-none focus:border-primary transition-all" placeholder="Escriba aqu√≠ el motivo del rechazo o notas internas..."></textarea>
            <div class="flex gap-4">
                <button onclick="procesar(false)" class="flex-1 h-14 rounded-2xl border-2 border-primary text-primary font-black text-[10px] uppercase tracking-widest active:scale-95 transition-all">Rechazar</button>
                <button onclick="procesar(true)" class="flex-[2] h-14 rounded-2xl bg-primary text-white font-black text-[10px] uppercase tracking-[0.2em] shadow-xl shadow-primary/20 active:scale-95 transition-all">Aprobar y Notificar</button>
            </div>
        </div>
    </footer>

    <script>
        // ASEG√öRATE QUE ESTA URL SEA LA DE TU √öLTIMA IMPLEMENTACI√ìN
            <script>
    // URL DE TU √öLTIMA IMPLEMENTACI√ìN
    const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbzileiH-CN1fIYY7J_pPQIg3YHLXy9NKtAS_ULgNT3LtrPRZHrlGo49a58w-jTzmWm2/exec';
    
    let db = { motorizados: [], tiendas: [] };
    let currentTab = 'motorizados';
    let currentItem = null;

    async function init() {
        try {
            // CORRECCI√ìN: Ahora usamos URL_SCRIPT (el nombre correcto)
            const response = await fetch(URL_SCRIPT);
            const data = await response.json();
            
            db.motorizados = data.motorizados || [];
            db.tiendas = data.tiendas || [];

            document.getElementById('countM').innerText = db.motorizados.length;
            document.getElementById('countT').innerText = db.tiendas.length;
            
            render();
        } catch (e) {
            console.error(e);
            // Si sale este error, es porque el script no tiene permisos de "Cualquiera"
            alert("Error de conexi√≥n. Aseg√∫rese de que el Script est√© publicado como 'Cualquiera' (Anyone).");
        }
    }

    function cambiarTab(tab) {
        currentTab = tab;
        document.getElementById('tM').className = tab === 'motorizados' ? "flex-1 py-4 text-[10px] font-black uppercase tab-active" : "flex-1 py-4 text-[10px] font-black uppercase text-zinc-500";
        document.getElementById('tT').className = tab === 'tiendas' ? "flex-1 py-4 text-[10px] font-black uppercase tab-active" : "flex-1 py-4 text-[10px] font-black uppercase text-zinc-500";
        render();
    }

    function render() {
        const list = currentTab === 'motorizados' ? db.motorizados : db.tiendas;
        const main = document.getElementById('main');
        const footer = document.getElementById('footer');
        const loading = document.getElementById('loading');
        const content = document.getElementById('content');

        loading.classList.add('hidden');
        content.classList.remove('hidden');

        if (!list || list.length === 0) {
            content.innerHTML = `
                <div class="py-20 text-center opacity-30">
                    <span class="material-symbols-outlined text-6xl">check_circle</span>
                    <p class="mt-4 text-[10px] font-black uppercase">No hay solicitudes en ${currentTab}</p>
                </div>`;
            footer.classList.add('hidden');
            return;
        }

        currentItem = list[0];
        footer.classList.remove('hidden');

        if (currentTab === 'motorizados') {
            content.innerHTML = `
            <div class="mb-8 animate-in fade-in slide-in-from-bottom duration-500">
                <h2 class="text-3xl font-black italic uppercase leading-none tracking-tighter">${currentItem.nombre || 'Sin nombre'}</h2>
                <p class="text-primary font-black text-xs uppercase mt-2 tracking-widest italic">${currentItem.marca || 'Marca'} ‚Ä¢ ${currentItem.placa || 'Placa'}</p>
                <div class="mt-4 flex gap-2">
                    <span class="px-2 py-1 bg-zinc-900 border border-border rounded text-[9px] font-bold text-zinc-400 uppercase">ID: ${currentItem.cedula}</span>
                    <span class="px-2 py-1 bg-zinc-900 border border-border rounded text-[9px] font-bold text-zinc-400 uppercase">TEL: ${currentItem.telefono}</span>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3">
                <p class="text-[9px] font-black uppercase text-zinc-600 tracking-widest ml-1">Documentaci√≥n Registrada</p>
                <button class="btn-doc text-primary border-primary/30" onclick="window.open('${currentItem.urlVideo}', '_blank')"><span class="material-symbols-outlined">videocam</span> VIDEO BIOM√âTRICO</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlCedFront}', '_blank')"><span class="material-symbols-outlined">badge</span> C√âDULA FRONTAL</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlCedPost}', '_blank')"><span class="material-symbols-outlined">badge</span> C√âDULA POSTERIOR</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlLicFront}', '_blank')"><span class="material-symbols-outlined">license</span> LICENCIA FRONTAL</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlLicPost}', '_blank')"><span class="material-symbols-outlined">license</span> LICENCIA POSTERIOR</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlPlanilla}', '_blank')"><span class="material-symbols-outlined">receipt</span> PLANILLA DE LUZ</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlAntecedentes}', '_blank')"><span class="material-symbols-outlined">gavel</span> ANTECEDENTES</button>
                <button class="btn-doc" onclick="window.open('${currentItem.urlBanco}', '_blank')"><span class="material-symbols-outlined">account_balance</span> CERT. BANCARIO</button>
            </div>`;
        } else {
            // Render para Tiendas
            content.innerHTML = `
            <div class="mb-8 animate-in fade-in slide-in-from-bottom duration-500">
                <h2 class="text-3xl font-black italic uppercase leading-none tracking-tighter">${currentItem.nombreTienda || 'Tienda'}</h2>
                <p class="text-primary font-black text-xs uppercase mt-2 tracking-widest italic">${currentItem.ciudad || 'Ciudad'}</p>
            </div>
            <div class="bg-card border border-border rounded-3xl p-6 space-y-4">
                <div><p class="text-[9px] font-black text-zinc-600 uppercase mb-1">Representante</p><p class="font-bold text-sm">${currentItem.representante}</p></div>
                <div><p class="text-[9px] font-black text-zinc-600 uppercase mb-1">RUC / ID</p><p class="font-bold text-sm">${currentItem.cedula}</p></div>
                <div><p class="text-[9px] font-black text-zinc-600 uppercase mb-1">Contacto</p><p class="font-bold text-sm">${currentItem.telefono}</p></div>
            </div>`;
        }
    }

    async function procesar(aprobado) {
        const nota = document.getElementById('notas').value;
        if(!aprobado && !nota) return alert("‚ùå Motivo de rechazo obligatorio.");
        
        if(!confirm(aprobado ? "¬øAprobar cuenta?" : "¬øEliminar registro?")) return;

        document.getElementById('footer').classList.add('opacity-50', 'pointer-events-none');

        const payload = {
            accion: "ACTUALIZAR_ESTADO",
            cedula: currentItem.cedula,
            tipoRegistro: currentTab === 'motorizados' ? 'motorizado' : 'tienda',
            nuevoEstado: aprobado ? "APROBADO" : "RECHAZADO",
            observaciones: nota
        };

        try {
            // CORRECCI√ìN: Aqu√≠ tambi√©n usamos URL_SCRIPT
            await fetch(URL_SCRIPT, { method: "POST", body: JSON.stringify(payload) });

            let telf = currentItem.telefono.toString().replace(/\D/g,'');
            if (telf.startsWith('0')) telf = telf.substring(1);
            if (!telf.startsWith('593')) telf = '593' + telf;

            let msj = aprobado ? 
                `*KM0* üèÅ%0AHola *${currentItem.nombre || currentItem.nombreTienda}*, tu cuenta ha sido *APROBADA*.%0A%0A*ACCESO:*%0Aüë§ Usuario: ${currentItem.cedula}%0Aüîë Clave: 123456789` :
                `*KM0* ‚ö†Ô∏è%0AHola, tu solicitud fue *RECHAZADA*.%0A*MOTIVO:* ${nota}`;
            
            window.open(`https://wa.me/${telf}?text=${msj}`, '_blank');
            location.reload();
        } catch (e) {
            alert("Error al procesar. Reintente.");
            document.getElementById('footer').classList.remove('opacity-50', 'pointer-events-none');
        }
    }

    init();
</script>
