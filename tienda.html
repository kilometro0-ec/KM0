<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Kilómetro 0 - Panel de Tiendas</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#ec1313",
                        "status-purple": "#9333ea",
                        "status-green": "#22c55e",
                        "background-light": "#f8f6f6",
                        "background-dark": "#120808",
                    },
                    borderRadius: { "DEFAULT": "1rem", "lg": "2rem" }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; min-height: 100vh; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .loading-overlay { display: none; }
        .loading-overlay.active { display: flex; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-white transition-colors duration-300">

    <div id="loginPage" class="fixed inset-0 z-[100] bg-background-dark flex items-center justify-center p-6">
        <div class="w-full max-w-sm space-y-8">
            <div class="text-center">
                <div class="bg-primary w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg shadow-primary/40">
                    <span class="material-symbols-outlined text-white text-4xl">speed</span>
                </div>
                <h2 class="text-3xl font-bold italic">KILÓMETRO 0</h2>
                <p class="text-slate-400 mt-2">Acceso para Tiendas</p>
            </div>
            <form id="formLogin" class="space-y-4">
                <input type="text" id="userLogin" placeholder="Identificación (RUC/Cédula)" class="w-full p-4 rounded-xl bg-white/5 border border-white/10 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" required>
                <input type="password" id="passLogin" placeholder="Contraseña" class="w-full p-4 rounded-xl bg-white/5 border border-white/10 focus:border-primary focus:ring-1 focus:ring-primary outline-none transition-all" required>
                <button type="submit" class="w-full py-4 bg-primary text-white font-bold rounded-xl hover:scale-[1.02] active:scale-95 transition-all">Ingresar</button>
            </form>
        </div>
    </div>

    <div id="mainContent" class="hidden flex flex-col min-h-screen">
        <header class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md border-b border-slate-200 dark:border-white/10">
            <div class="flex items-center justify-between px-4 py-4">
                <div class="flex items-center gap-3">
                    <div class="bg-primary p-1.5 rounded-lg">
                        <span class="material-symbols-outlined text-white text-xl">speed</span>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight" id="storeNameDisplay">Mi Tienda</h1>
                </div>
                <button onclick="logout()" class="p-2 text-slate-400"><span class="material-symbols-outlined">logout</span></button>
            </div>
            <div class="px-4 pb-4">
                <div class="flex h-11 items-center justify-center rounded-full bg-slate-200 dark:bg-white/5 p-1">
                    <button class="flex-1 h-full rounded-full text-sm font-bold bg-white dark:bg-[#2a1818] text-primary dark:text-white shadow-sm">En curso</button>
                    <button class="flex-1 h-full rounded-full text-sm font-bold text-slate-500">Historial</button>
                </div>
            </div>
        </header>

        <main class="flex-1 px-4 py-4 space-y-4" id="pedidosContainer">
            <div class="text-center py-10 text-slate-500">No hay pedidos activos hoy</div>
        </main>

        <nav class="sticky bottom-0 bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-lg border-t border-slate-200 dark:border-white/10 pb-8 pt-2">
            <div class="flex justify-around items-center px-4">
                <button class="flex flex-col items-center gap-1 text-primary"><span class="material-symbols-outlined">grid_view</span><span class="text-[10px] font-bold">INICIO</span></button>
                <button class="flex flex-col items-center gap-1 text-slate-400"><span class="material-symbols-outlined">local_mall</span><span class="text-[10px] font-bold">PEDIDOS</span></button>
                <button onclick="abrirModal()" class="flex flex-col items-center justify-center -mt-8 size-14 bg-primary rounded-full shadow-lg shadow-primary/40 text-white hover:scale-110 transition-transform">
                    <span class="material-symbols-outlined text-3xl">add</span>
                </button>
                <button class="flex flex-col items-center gap-1 text-slate-400"><span class="material-symbols-outlined">analytics</span><span class="text-[10px] font-bold">REPORTES</span></button>
                <button class="flex flex-col items-center gap-1 text-slate-400"><span class="material-symbols-outlined">store</span><span class="text-[10px] font-bold">PERFIL</span></button>
            </div>
        </nav>
    </div>

    <div id="modalPedido" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
        <div class="bg-white dark:bg-background-dark w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-slate-200 dark:border-white/10 p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Crear Nuevo Pedido</h2>
                <button onclick="cerrarModal()" class="text-slate-400"><span class="material-symbols-outlined">close</span></button>
            </div>
            <form id="formNuevoPedido" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="ciudad" placeholder="Ciudad" class="p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                    <input type="text" id="cliente" placeholder="Cliente" class="p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                </div>
                <input type="tel" id="telCliente" placeholder="Teléfono Cliente" class="w-full p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                <input type="text" id="direccion" placeholder="Dirección de entrega" class="w-full p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                <div class="grid grid-cols-3 gap-3">
                    <input type="number" id="cantidad" placeholder="Cant." class="p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                    <input type="text" id="detalle" placeholder="Producto" class="col-span-2 p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                </div>
                <input type="number" id="valor" placeholder="Valor a recaudar ($)" class="w-full p-3 rounded-xl bg-slate-100 dark:bg-white/5 border-none" required>
                <button type="submit" id="btnEnviar" class="w-full py-4 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/30">Enviar Pedido</button>
            </form>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const WEB_APP_URL = "TU_URL_DE_GOOGLE_APPS_SCRIPT_AQUI"; 
        let TIENDA_ACTUAL = localStorage.getItem('km0_tienda') || "";

        // --- MANEJO DE LOGIN ---
        if(TIENDA_ACTUAL) { mostrarPanel(TIENDA_ACTUAL); }

        document.getElementById('formLogin').onsubmit = async (e) => {
            e.preventDefault();
            const user = document.getElementById('userLogin').value;
            const pass = document.getElementById('passLogin').value;
            
            // Llamada al script de Google (Accion: LOGIN)
            const res = await fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: "LOGIN", tipo: "tienda", usuario: user, clave: pass })
            });
            const data = await res.json();

            if(data.status === "SUCCESS") {
                localStorage.setItem('km0_tienda', data.nombre);
                mostrarPanel(data.nombre);
            } else {
                alert("❌ Credenciales incorrectas");
            }
        };

        function mostrarPanel(nombre) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('storeNameDisplay').innerText = nombre;
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // --- MODAL Y PEDIDOS ---
        function abrirModal() { document.getElementById('modalPedido').classList.remove('hidden'); }
        function cerrarModal() { document.getElementById('modalPedido').classList.add('hidden'); }

        document.getElementById('formNuevoPedido').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnEnviar');
            btn.disabled = true;
            btn.innerText = "Procesando...";

            const pedido = {
                accion: "NUEVO_PEDIDO",
                tienda: localStorage.getItem('km0_tienda'),
                ciudad: document.getElementById('ciudad').value,
                cliente: document.getElementById('cliente').value,
                telCliente: document.getElementById('telCliente').value,
                direccion: document.getElementById('direccion').value,
                cantidad: document.getElementById('cantidad').value,
                detalle: document.getElementById('detalle').value,
                valor: document.getElementById('valor').value
            };

            try {
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(pedido) });
                alert("✅ Pedido creado exitosamente");
                cerrarModal();
                e.target.reset();
            } catch (err) {
                alert("Error al conectar");
            } finally {
                btn.disabled = false;
                btn.innerText = "Enviar Pedido";
            }
        };
    </script>
</body>
</html>
